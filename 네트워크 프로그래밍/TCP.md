# TCP

### 3단계 메시지 교환

- 3 Way Handshake
- 두 종단점간에 SYN, SYN/ACK 그리고 ACK 메시지가 순차적으로 전송되어 링크를 생성하는 과정

---

---

## 1. TCP 특성

### 1. 계층적 모델

- OSI 모델에서 전송층 (Transport Layer)에 해당하는 제 4계층의 프로토콜
- 송신프로세스와 수신프로세스 사이의 `종단점 (End-to-End) 통신을 지원`

```
IP : 장치간의 통신
TCP : 어플리케이션 간의 통신을 위한 모델
```

### 2. 역할

- TCP 세그먼트는 IP 패킷의 페이로드(SDU)에 캡슐화(Encapsulation)되어 전송됨
- 하단의 계층으로 전달될수록 헤더와 테일러가 붙음
- 연결 지향형 (Connection Oriented)
  - 데이터의 송수신을 위해 서버와 클라이언트 개념을 통해 `사전에 통신 채널을 생성`
- 안정적인 데이터 전송

  - 연결설정 -> 데이터 송/수신 -> 연결 종료
  - 세 단계를 수행
  - IP 계층에서는 데이터의 보존을 보장하지 않는다.

- 연결 과정
  - 3단계 메시지 교환 (3 Way Handshake) 방식을 사용
  - 연결을 위해 `최소` 1.5 x RTT (Round Trip Time)이 필요
- 연결 해제 과정

  - `상대측이 연결을 종료할 떄까지 기다린 후에` 자신도 종료하는 대기과정
  - 대기 시간
    - 전송한 ACK 세그먼트가 버려지기 이전에 네트워크에 남아 있을 수 있는 `최대시간(MSL: Maximum Segment Lifetime)의 두 배`

- 신뢰성 제공

  - 종단에서는 `전달되는 세그먼트에 일련번호(Sequence ID)를 사용`
    - 세그먼트 누락 해결
    - 순서 교정
    - 중복 세그먼트 방지

  > 세그먼트가 잘 수신되고 있음을 송신측에 알리기 위해 ACK 기법을 사용

- 흐름 제어 (Flow Control)
  - 네트워크의 상태에 따라 적당한 크기의 세그먼트를 전송

> 이동창 (Sliding Window) 기법
>
> > 송신창(Send Window)를 사용하여 응낙이 도착되기 전에 정해진 데이터의 최대 양을 전송할 수 있도록 함
> > 보낸 메시지의 응답이 오기전에 미리 다음 메시지를 보내는 것

```
정체 제어 (Congestion Control)
- 정체 제어를 위해 정체 창(Congestion window)를 사용
- 메시지가 손실될 때마다, TCP는 정체 제어를 시작 (Slow Start 기법)
    - 응낙 손실이 없으면, 직전에 보냈던 데이터의 두 배의 세그먼트를 전송
    - 손실이 있으면 증가율을 반으로 감소 전송

- 정체 (Congestion)
    - 전송 경로에 너무 많은 데이터가 전송
    - 전송 채널의 활용도가 증가하여 과도한 전송 지연의 발생
- 정체 붕괴 (Congestion Collapse)
    - 정체가 지속되어 더 이상 세그먼트를 받아들일 수 없는 상태
    - Time out 등

- 데이터를 바이트들의 연속으로 간주하여 정송
- 응용 프로그램의 전송 함수는 송신 프로그램의 버퍼에서 TCP의 전송 버퍼로 운반
- 실제 목적지로의 데이터 전송은 OS에 의해 별도로 처리
```

---

## 2. TCP 세그먼트

### 1. 헤더 구조

- TCP는 최소 20바이트의 헤더를 가짐
  - 크기는 가변화
- 연속하는 스트림데이터의 특성을 가짐 (연속성)
- 접속 종료때까지 하나의 스트림으로 간주
- 데이터의 경계가 없음

  - 프로그램적으로 나눠야 함

| 이름                        | 내용                                                                                                               |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| Source Port (16비트)        | 운영체제내 송신 프로세스(또는 데몬)의 주소(포트번호)                                                               |
| Destination Port (16비트)   | 운영체제내 수신 프로세스(또는 데몬)의 주소(포트번호)                                                               |
| Sequence Number (32비트)    | TCP 세그먼트의 일련번호                                                                                            |
| Acknowledge Number (32비트) | 다음번에 수신될 것으로 예상되는 세그먼트의 일련번호, `수신된 일련번호에 1을 증가한 값`                             |
| Header Length (4비트)       | 헤더의 크기 (지정 크기 x 4, 기본값: 101b), 60(111)b가 헤더의 최대 크기, 세그먼트내 데이터의 시작 위치를 알 수 있음 |
| NOT USED (6비트)            | 사용하지 않음 (0으로 설정됨)                                                                                       |
| FLAG, 코드 (6비트)          | URG (긴급), ACK (유효), PSH (push), RST (연결 초기화), SYN (연결 설정), FIN (연결 해제)                            |
| Window (16비트)             | 수신 가능 버퍼의 크기, 정체제어, 흐름제어를 위함                                                                   |
| Checksum (16비트)           | TCP 세그먼트 전체에 대한 오류 검출                                                                                 |
| Urgent Point (16비트)       | URG 플래그가 1일 때 사용되는 값, 응급데이터의 위치                                                                 |
